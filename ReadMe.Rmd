---
title: "HIVprimertestR Pipeline"
author: 'Mohith Reddy Arikatla'
date: "2025-09-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

`HIVprimertestR` is an R-based pipeline designed to evaluate HIV-1 primers and probes for binding success against a user-defined set of query sequences. The pipeline calculates Hamming distances between primers/probes and query sequences and assesses oligo performance based on mismatch counts across viral populations in the query set.

### Input Requirements

-   One `.csv` file containing input primers/probes and one corresponding query dataset in `.csv` format for each primer/probe to test against.

Note: example input files are provided in the `ExampleINPUT` directory.

### Output Summary

The script outputs summary statistics that describe the sequence similarity of each primer/probe across the query datasets, including:

-   Hamming distance (HD) summaries for full primer length, 5′ half, 3′ half, and the 3′ terminal two nucleotides
-   Percentage of input sequences qualifying under three evaluation criteria (Definitions #1, #2, and #3)

### Example Output Table

```{r exampleOutputTable, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
exampleOutputTable <- "
|                                            | ExamplePrimer1         | ExamplePrimer2         |
|--------------------------------------------------|-------------------------|-------------------------|
| Sample Size                                      | 3                       | 3                       |
| Median HD (Full Length)                          | 0.5 (0.25–0.75)         | 1.5 (1.25–1.75)         |
| Median HD (5′ Half)                              | 0.5 (0.25–0.5)          | 0.5 (0.25–0.5)          |
| Median HD (3′ Half)                              | 0 (0–0.25)              | 1 (1–1.25)              |
| Median HD (3′ Terminal 2 nt)                     | 0 (0–0)                 | 0 (0–0)                 |
| Percent Qualified (Definition 1)                 | 100%                    | 66.67%                  |
| Percent Qualified (Definition 2)                 | 100%                    | 66.67%                  |
| Percent Qualified (Definition 3)                 | 33.33%                  | 0%                      |
"
cat(exampleOutputTable)
```

Note: example output files are provided in the `ExampleRESULTS` directory.

### Software Requirements

The current version of `HIVprimertestR` was built using **R version 4.4.2**. Please ensure you have this version (or newer) installed. The following R packages are required:

```{r Packages, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
table0 <- "
| Package        | Minimum Version | Installation Command                                      |
|----------------|:-----------------|:-----------------------------------------------------------|
| `BiocManager`  | 1.30.25          | `install.packages(\"BiocManager\")`                         |
| `Biostrings`   | 2.74.1           | `BiocManager::install(\"Biostrings\")`                      |
| `dplyr`        | 1.1.4            | `install.packages(\"dplyr\")`                               |
| `msa`          | 1.38.0           | `BiocManager::install(\"msa\")`                             |
| `pwalign`      | 1.2.0            | `BiocManager::install(\"pwalign\")`                         |
| `tools`        | 4.4.2            | *(Included with base R; no separate installation needed)* |
"
cat(table0)
```

To install all required packages, run the following commands in R:

```{r eval=FALSE}
install.packages("BiocManager")
BiocManager::install(c("Biostrings", "msa", "pwalign"))
install.packages("dplyr")
```

Note: If you face challenges in successfully installing/importing any of the above-mentioned packages, please check your `R` or `BiocManager` version(s).

### How to Install R and RStudio

1.  **Download and Install R**
    -   Visit the [CRAN R Project site](https://cran.r-project.org/)
    -   Choose your operating system (Windows, macOS, or Linux)
    -   Download the latest version of R and follow the installation instructions
2.  **Download and Install RStudio (Recommended IDE)**
    -   Visit the [RStudio download page](https://posit.co/download/rstudio-desktop/)
    -   Download the **RStudio Desktop (Free)** version for your operating system
    -   Install RStudio after installing R
3.  **Launch RStudio**
    -   Open RStudio
    -   You can run R scripts or R Markdown documents directly from the interface

## Pipeline Description

### Quick Start

1.  Download and unzip this repository.
2.  Create input files as described in the "Expected Input" section and place them in the `INPUT/` directory.
3.  Open the R script named `HIVprimertestR.V23.R` (or the current latest version).
4.  If you’re using RStudio, click the “Source” button. Otherwise, select all the code (Cmd + A on macOS or Ctrl + A on Windows/Linux) and press Enter/Return to run it.
5.  Check the `RESULTS/` directory for the output.

### Expected Input

##### 1. `PrimersINPUT.csv`: a two-column input file. The first column containing the primer/probe's unique name and the second column containing the nucleotide sequence associated with the primer/probe in 5' to 3' orientation.

Important Note: If your primer or probe is designed to bind in the reverse orientation to the viral genome (like a reverse primer does), you must enter its reverse complement sequence in the input file.

For example: If your reverse primer is: `5’-TCATGAGTCYACTASC-3’` then you should enter its reverse complement: `5’-GSTAGTRGACTCATGA-3’` in the input file. You can produce a reverse complement sequence using many number of online tools, for example: <https://reverse-complement.com/>. This is necessary so the sequence can be correctly matched to the 5’ to 3’ orientation of the proviral genome template strand used for alignment and analysis.

Primers Input file format:

```{r PrimersINPUT.csv, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
table1 <- "
| PrimerName | Sequence |
|:------------|:----------------------------|
| ForwardPrimer | TCTCGACGCAGGACTCG |
| ReversePrimer_RevComp | GSTAGTRGACTCATGA |
"
cat(table1)
```

##### 2. Primer-wise trimmed query dataset(s): one .csv file named after each query primer.

Note #1: Do not use the period(".") character in any of the name fields. This tool uses periods to construct FASTA headers and to separate internal fields for all functions. Including periods in names may result in errors or mislabeling during processing. You are free to use hyphens("-") or underscores("\_") to distinguish values within name fields instead.

Note #2: If any of your primers/probes fall entirely within the LTR regions in HIV-1, you can supply separate query files with the naming format `PrimerName.3LTR.csv` and `PrimerName.5LTR.csv`. Per each SeqID, one representative sequence is chosen with a preference for sequences from 5' LTR.

Example:

1.  `ForwardPrimer.csv`

```{r ForwardPrimer.csv, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
table2 <- "
| GroupName | DonorID | SeqID | Sequence |
|:----------|:--------|:------|:---------|
| Subtype1_Country1 | Donor1 | Seq1 | TCTCGACGCAGGACTCG |
| Subtype1_Country1 | Donor2 | Seq1 | TCACGACGCAGGACTCG |
| Subtype1_Country1 | Donor2 | Seq2 | TCTCGACGCAGAACACG |
| Subtype1_Country2 | Donor3 | Seq1 | TCTCGACAAAGAACTCG |
"
cat(table2)
```

2.  `ReversePrimer_RevComp.csv`

```{r ReversePrimer_RevComp.csv, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
table3 <- "
| GroupName | DonorID | SeqID | Sequence |
|:----------|:--------|:------|:---------|
| Subtype1_Country1 | Donor1 | Seq1 | GSTAGTRGACTCATAA |
| Subtype1_Country1 | Donor1 | Seq2 | GSTAGTRGACTCATGA |
| Subtype1_Country1 | Donor2 | Seq1 | GSTAGTAGACTCATGA |
| Subtype1_Country2 | Donor3 | Seq1 | GSTAGCRGACTCATGA |
"
cat(table3)
```

### User-Defined Options

These options can be adjusted based on your needs. All parameters can be found in the R script.

1.  `sampling = F`

    -   Set to `T` to randomly sample sequences/donors to a specified size.

2.  `maxSampleSize = 100`

    -   Defines the sample size number (used only if `sampling = T`).

3.  `filterToggleList = c(T, F)`

    -   Keep as is to run the analysis **with** and **without** a sequence quality filter.\
    -   Set to `c(T)` to run the analysis **only with** the quality filter.\
    -   Set to `c(F)` to run the analysis **only without** the quality filter.

    **Note:** The sequence quality filter removes query sequences that are

    -   shorter than 50% or longer than 150% of the corresponding primer/probe length,\
    -   or have mismatch counts \>50% of primer/probe length after multiple sequence alignment (MSA).

4.  `donorwiseConsensusToggleList = c(T, F)`

    -   Keep as is to run the analysis **with** and **without** donor-wise consensus.\
    -   Set to `c(T)` to run the analysis **only with** donor-wise consensus.\
    -   Set to `c(F)` to run the analysis **only on individual sequences**.

    **Note:** Donor-wise consensus sequences are generated using the\
    `consensusString()` function from the **Biostrings** package.

    -   For each donor, a per-base majority rule is applied.\
    -   IUPAC ambiguity codes (e.g., R, Y, N) are introduced when polymorphisms occur at ≥25% frequency (default threshold = 0.25).\
    -   The threshold can be modified by changing the `threshold` argument in the `generateConsensus()` function.

### Criteria for Primer/Probe Qualification

![](README/Criteria%20for%20primer%20qualification.png)

### Assessment Definitions

**Definition #1**\
For probes, more than 1 mismatch immediately results in a “FALSE” (fail) status.\
For primers, allow up to 3 mismatches in the 5′ half and 1 in the 3′ half.

**Definition #2**\
For probes, more than 1 mismatch immediately results in a “FALSE” (fail) status.\
For forward and reverse primers, any mismatch between the primer and the target sequence in the last two bases at the 3’ end of the primer leads to a "FALSE" (fail) status assignment to the query sequence.

**Definition #3**\
Requires 100% sequence identity with the primer/probe for a "TRUE" (pass) status.

### Methods: Statistics Pipeline

#### Step 1: Input

-   For each primer/probe, the query datasets are read in `.csv` format and converted into sequence objects using the **Biostrings** package in R.

#### Step 2: Pre-processing

**a. LTR-specific handling**

-   If the primer/probe falls entirely within the LTR regions:
    -   Because within a genome, the HIV-1 LTR regions are mostly identical, the user may supply separate query datasets with sequences from the 5′ and 3′ LTR regions so that one representative sequence is chosen per `DonorID` per `seqID`.\
    -   If within a `DonorID` the same `seqID` has sequences from both LTRs, the **5′ LTR sequence** is chosen to represent that `seqID`.\
    -   If the `seqID` only has a sequence from one LTR (5′ or 3′), that sequence is chosen.\
-   Otherwise, skip to **Step 2b**.

**b. Sequence filtering**

-   If filtering is enabled:
    -   Sequences with \<50% or \>150% of the primer/probe length (based on the number of non-gap characters) are removed.\
-   Otherwise, skip to **Step 2c**.

**c. Donor-wise consensus generation**

-   If donor-wise consensus is enabled:
    -   Sequences being queried against a primer/probe from each `DonorID` are aligned with the `msa()` function (using the **Muscle** algorithm) from the **msa** package (v1.38.0).\
    -   This MSA object is passed to the `consensusString()` function from **Biostrings** to generate a per-base majority-rule consensus sequence for each `DonorID`.\
    -   **IUPAC ambiguity codes** (e.g., R, Y, N) are introduced when polymorphisms occur at ≥25% frequency (default `threshold = 0.25`).\
    -   The minimum required frequency to introduce IUPAC ambiguity codes can be adjusted by modifying the `threshold` argument in the `generateConsensus()` function call within the `HIVprimertestR.V23.R` script.\
-   Otherwise, skip to **Step 2d**.

**d. Unique sequence extraction**

-   After pre-processing, all gaps are removed.\
-   Unique sequences from each dataset are carried forward into the analysis step.

#### Step 3: Analysis

**a. Multiple sequence alignment (MSA)**

-   The primer/probe sequence is added to the query sequence object, and MSA is performed.\
-   Based on the primer/probe length:
    -   The MSA object is split into a 5′ half and a 3′ half.\
    -   If the length is odd, the middle position is attributed to the 5′ half.\
    -   An additional MSA object containing only the last two nucleotides is extracted for **Definition #2** evaluation.

**b. Mismatch count calculation**

-   For each query sequence vs. primer/probe comparison:
    -   **Exact match:** no penalty.\
    -   **Both degenerate bases:** partial mismatch penalty (e.g., if reference = R [A/G] and query = D [A/G/T], penalty = 0.33 since 1/3 of query population could lead to a mismatch).\
    -   **Reference degenerate only:** no penalty if query is included; otherwise, +1 mismatch.\
    -   **Query degenerate only:** partial penalty if reference base is included (e.g., if ref = A and query = W [A/T], penalty = 0.5 since 1/2 of query population could lead to a mismatch); otherwise, +1 mismatch.\
    -   **Neither matches:** +1 mismatch.

**c. Re-filtering (if filer is enabled)**

-   Query sequences with mismatch scores exceeding 50% of the primer/probe length are excluded.\
-   The analysis (Step 3a–3b) is re-run on the filtered dataset.\
-   Otherwise, skip to **Step 3d**.

**d. Applying prediction criteria**

-   Based on mismatch scores, Assessent **Definitions #1, #2 and #3** are applied.\
-   Each query sequence (or donor consensus, if enabled) is assigned a **TRUE/FALSE** (PASS/FAIL) status against all three assessment Definitions.

#### Step 4: Summary Statistics

-   For each `groupName` (see *Primer-wise trimmed query dataset* in **Expected Input**), summary statistics are calculated against all primers/probes:
    -   Median and quantiles of Hamming distances (mismatch scores).\
    -   Percent of the population passing each prediction criterion.\
-   Results are exported into output files.

### Expected Output

After a successful run of this script, the following files and directories will be generated:

1.  **Analysis configuration sub-directories (within `RESULTS/`)**

    -   A separate sub-directory is created for each combination of the `filterToggleList` and `donorwiseConsensusToggleList` arguments.\
    -   Example 1: If `filterToggleList = c(T)` and `donorwiseConsensusToggleList = c(F)`, the directory will be:\
        `Filter.TRUE_DonorwiseConsensus.FALSE`\
    -   Example 2: If `filterToggleList = c(T,F)` and `donorwiseConsensusToggleList = c(T)`, three directories will be created:
        -   `Filter.TRUE_DonorwiseConsensus.TRUE`\
        -   `Filter.FALSE_DonorwiseConsensus.TRUE`\
        -   `Filter.TRUE_DonorwiseConsensus.FALSE`

2.  **Group-wise mismatch statistics summary files**

    -   Within each analysis configuration sub-directory, one output file is generated per unique `groupName` across all query dataset files.\
    -   Each file contains:
        -   Sample size (number of sequences/donors)\
        -   Median mismatch score (HD) for: full-length primer, 5′ half, 3′ half, and the 3′ terminal 2 nucleotides\
        -   First and third quantiles for these statistics\
        -   A `PercentQualified.Definition#` row reporting the percent of the population that passed each prediction criterion.\
    -   Example: If `groupName` values are `Subtype1-Country1`, `Subtype2-Country1`, and `Subtype2-Country2`, the following files will be generated:
        -   `Subtype1-Country1_HDSummary.csv`\
        -   `Subtype2-Country1_HDSummary.csv`\
        -   `Subtype2-Country2_HDSummary.csv`

3.  **Combined sequences**

    -   If any primers from the LTR regions are used, representative sequences per `SeqID` are output as `.fasta` files in the `Combined/` sub-directory.

4.  **Consensus sequences**

    -   If `donorwiseConsensusToggleList` includes `T` (e.g., `c(T,F)`, `c(T)`, or `c(F,T)`), donor-wise consensus sequences are generated for each primer/probe and saved as `.fasta` files in the `Consensus/` sub-directory.

5.  **Collapsed sequences**

    -   Per `groupName`, all unique sequences being queried against the corresponding primer/probe are output as `.fasta` files in the `Collapsed/` sub-directory.

6.  **Representation**

    -   Per `groupName`, all unique sequences being queried against the corresponding primer/probe are output as `.fasta` files in the `Representation/` sub-directory. Additionally, the sequence headers contain the information on how many sequences/donors have the corresponding sequence and the percent of the group this sequence represents.

7.  **Hamming Distance RAW**

    -   Per `groupName`, information on every unique query sequence's mismatch counts against the corresponding primer/probe for; full length, 5' half, 3' half, and 3' terminal 2 nucleotides are listed along with pass/fail status against Definitions #1-3 in `.csv` files in the `HammingDistanceRAW/` sub-directory, each named in the following format: `groupName_hammingDistance.csv`
    -   Example: If `groupName` values are `AG-CM`, and `B-US`, the following files will be generated:
        -   `AG-CM_hammingDistance.csv`\
        -   `B-US_hammingDistance.csv`

Here is an example of what the results might look like if you run **Example 1** (provided in the repository).

``` text
RESULTS/
├── Filter.TRUE_DonorwiseConsensus.TRUE/  
│   ├── Subtype1-Country1_HDSummary.csv 
│   ├── Subtype1-Country2_HDSummary.csv 
│   ├── Subtype2-Country1_HDSummary.csv  
│   ├── Subtype2-Country2_HDSummary.csv  
│   ├── Combined/  
│   │   ├── Subtype1-Country1.ExamplePrimer1.Combined.fasta
│   │   ├── Subtype1-Country1.ExamplePrimer2.Combined.fasta    
│   │   ├── Subtype1-Country2.ExamplePrimer1.Combined.fasta
│   │   ├── Subtype1-Country2.ExamplePrimer2.Combined.fasta 
│   │   ├── Subtype2-Country1.ExamplePrimer1.Combined.fasta
│   │   ├── Subtype2-Country1.ExamplePrimer2.Combined.fasta    
│   │   ├── Subtype2-Country2.ExamplePrimer1.Combined.fasta
│   │   └── Subtype2-Country2.ExamplePrimer2.Combined.fasta 
│   ├── Consensus/  
│   │   ├── Subtype1-Country1.ExamplePrimer1.Consensus.fasta
│   │   ├── Subtype1-Country1.ExamplePrimer2.Consensus.fasta    
│   │   ├── Subtype1-Country2.ExamplePrimer1.Consensus.fasta
│   │   ├── Subtype1-Country2.ExamplePrimer2.Consensus.fasta 
│   │   ├── Subtype2-Country1.ExamplePrimer1.Consensus.fasta
│   │   ├── Subtype2-Country1.ExamplePrimer2.Consensus.fasta    
│   │   ├── Subtype2-Country2.ExamplePrimer1.Consensus.fasta
│   │   └── Subtype2-Country2.ExamplePrimer2.Consensus.fasta  
│   ├── Collapsed/  
│   │   ├── Subtype1-Country1.ExamplePrimer1.Collapsed.fasta
│   │   ├── Subtype1-Country1.ExamplePrimer2.Collapsed.fasta    
│   │   ├── Subtype1-Country2.ExamplePrimer1.Collapsed.fasta
│   │   ├── Subtype1-Country2.ExamplePrimer2.Collapsed.fasta 
│   │   ├── Subtype2-Country1.ExamplePrimer1.Collapsed.fasta
│   │   ├── Subtype2-Country1.ExamplePrimer2.Collapsed.fasta    
│   │   ├── Subtype2-Country2.ExamplePrimer1.Collapsed.fasta
│   │   └── Subtype2-Country2.ExamplePrimer2.Collapsed.fasta
│   ├── Representation/  
│   │   ├── Subtype1-Country1.ExamplePrimer1.MSA.fasta
│   │   ├── Subtype1-Country1.ExamplePrimer2.MSA.fasta    
│   │   ├── Subtype1-Country2.ExamplePrimer1.MSA.fasta
│   │   ├── Subtype1-Country2.ExamplePrimer2.MSA.fasta 
│   │   ├── Subtype2-Country1.ExamplePrimer1.MSA.fasta
│   │   ├── Subtype2-Country1.ExamplePrimer2.MSA.fasta    
│   │   ├── Subtype2-Country2.ExamplePrimer1.MSA.fasta
│   │   └── Subtype2-Country2.ExamplePrimer2.MSA.fasta 
│   └── HammingDistanceRAW/  
│       ├── Subtype1-Country1_hammingDistance.csv  
│       ├── Subtype1-Country2_hammingDistance.csv  
│       ├── Subtype2-Country1_hammingDistance.csv  
│       └── Subtype2-Country2_hammingDistance.csv  
│
├── Filter.TRUE_DonorwiseConsensus.FALSE/  
│   └── (same structure as above)  
│
├── Filter.FALSE_DonorwiseConsensus.TRUE/  
│   └── (same structure as above)  
│
└── Filter.FALSE_DonorwiseConsensus.FALSE/  
    └── (same structure as above)  
```
